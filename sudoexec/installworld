#!/bin/sh
#v9.2.2
globalconf="${workdir}/cbsd.conf";
CBSDMODULE="build"
MYARG=""
MYOPTARG="ver arch basename stable destdir"
MYDESC="Installbase from obj"
ADDHELP="ver=head for current.\n\
stable=1 for RELENG_X\n\
destdir= for alternative install path in root dir\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${color}
. ${etcdir}/buildworld.conf
init $*

# By default ver=current version
. ${buildconf}

SRC="${srcdir}/src_${ver}"

if [ -z "${basename}" ]; then
    DST="${basejaildir}/${basejailpref}_${arch}_${ver}"
else
    DST="${basejaildir}/${basejailpref}_${basename}_${arch}_${ver}"
fi

if [ -z "${basename}" ]; then
    export __MAKE_CONF=${etcdir}/make.conf
else
    export __MAKE_CONF=${etcdir}/make-$basename.conf
fi

if [ -z "${basename}" ]; then
    export MAKEOBJDIRPREFIX=${srcdir}/obj_${arch}_${ver}
else
    export MAKEOBJDIRPREFIX=${srcdir}/obj_${basename}_${arch}_${ver}
fi

if [ -z "${basename}" ]; then
    export SRCCONF=${etcdir}/src.conf
else
    export SRCCONF=${etcdir}/src-${basename}.conf
fi

support_arch=0

for i in $SUPPORTED_ARCH; do
    [ "${arch}" = "${i}" ] && support_arch=1 && break
done

[ ${support_arch} -eq 0 ] && err 1 "${MAGENTA}Supported architecture only: ${GREEN}${SUPPORTED_ARCH}${NORMAL}"

[ -n "${destdir}" ] && DST="${destdir}"
[ -d "${SRC}" ] || err 1 "${MAGENTA}No such source: ${GREEN}${SRC}${NORMAL}"
[ -d "${DST}" ] || /bin/mkdir -p ${DST}

LOCKFILE=${ftmpdir}/`md5 -qs ${MAKEOBJDIRPREFIX}`.lock

myarch=`uname -m`

if [ "${myarch}" != "${arch}" ]; then
    case "${arch}" in
	"i386")
	    export TARGET="i386"
	    export TARGET_ARCH="i386"
	    ;;
	"amd64")
	    export TARGET="amd64"
	    export TARGET_ARCH="amd64"
	    ;;
	"arm")
	    export TARGET="arm"
	    export TARGET_ARCH="armv6"
	    export BUILDPATH="arm-bsd-user"
	    export EMULATOR="qemu-arm"
	    ;;
	"mips")
	    export TARGET="mips"
	    export TARGET_ARCH="mips64"
	    export BUILDPATH="mips64-bsd-user"
	    export EMULATOR="qemu-mips64"
	    ;;
    esac
fi

makelock $LOCKFILE
/usr/bin/make -C ${SRC}/src installworld distribution DESTDIR=${DST} TARGET=${arch}
[ $? -ne 0 ] && err 1 "${MAGENTA}Installworld error${NORMAL}"
cbsd preparebase dst=$DST emulator=${EMULATOR}
