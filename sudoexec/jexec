#!/usr/local/bin/cbsd
#v11.1.0
MYARG="jname"
MYOPTARG="cmd"
MYDESC="Execution for command inside jail"
CBSDMODULE="jail"

. ${subr}
. ${strings}
init $*

[ -z "${jname}" ] && err 1 "Give me jname"

shift  # todo: jname and cmd may have reverse order

[ -z "${cmd}" ] && cmd="${@}"
[ -z "${cmd}" ] && err 1 "Empty command"

. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"
[ "${emulator}" = "bhyve" ] && err 1 "${MAGENTA}Not for bhyve mode${NORMAL}"

[ ${jid} -ne 0 ] || err 1 "Not running"

#rctl/limits area
. ${workdir}/rctl.subr
[ -z "${nice}" ] && nice="0"

nice=$( cbsdsql local SELECT nice FROM rctl WHERE jname=\"${jname}\" 2>/dev/null )
[ -z "${nice}" ] && nice="0"

if [ ${exec_fib} -eq 0 ]; then
	SETFIB=""
else
	SETFIB="setfib ${exec_fib}"
fi

if [ "${cpuset}" = "0" ]; then
	CPUSET=""
else
	CPUSET="cpuset -c -l ${cpuset}"
fi

case "${ver}" in
	"empty")
		# is linux?
		if [ -f "${data}/bin/bash" ]; then
			LOGIN_STR="/bin/bash"
		elif [ -f "${data}/bin/sh" ]; then
			LOGIN_STR="/bin/sh" ];
		else
			err 1 "${MAGENTA}Unknown environment, unable to login${NORMAL}"
		fi
		;;
	*)
		if [ "${emulator}" != "jail" -a -n "${emulator}" ]; then
			. ${workdir}/emulator.subr
			init_usermode_emul
			LOGIN_STR="/bin/${emulator} /bin/sh"
		else
			LOGIN_STR="/bin/sh"
		fi
		;;
esac

/usr/bin/nice -n ${nice} ${SETFIB} ${CPUSET} /usr/sbin/jexec ${jid} ${LOGIN_STR} <<CBSD_EOF
${cmd}
CBSD_EOF
