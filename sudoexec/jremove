#!/bin/sh
#v10.0.2
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="jname"
MYDESC="Destroy jail"
CBSDMODULE="jail"
EXTHELP="html/wf_jremove_en.html"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${jfs}
. ${strings}
. ${color}

init $*

if [ -n "$jname" ]; then
    JLIST=$jname
else
    JLIST=$*
fi

[ -z "$JLIST" ] && err 1 "Give me jname"

for jname in ${JLIST}; do
    DST="${jaildatadir}/${jname}-${jaildatapref}"
    JAILDIR="${jaildir}/${jname}"
    JAILFSTAB="${jailfstabdir}/${jailfstabpref}${jname}"
    JAILRCCONF="${jailrcconfdir}/rc.conf_${jname}"

    unregister=0

    . ${jrcconf}

    if [ $? -eq 1 ]; then
	if [ ! -f "${JAILRCCONF}" ]; then
	    ${ECHO} "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"
	    continue
	else
	    . ${JAILRCCONF}
	    unregister=1
	fi
    fi

    if [ ${unregister} -eq 0 ] ; then
	[  ${jid} -ne 0 ] && cbsd jstop jname=${jname}
	cbsd jcleanup jname=${jname}
	[ ${zfsfeat} -eq 1 ] && cbsd jsnapshot mode=destroyall jname=${jname}
	cbsd junregister jname=${jname}
    fi

    [ -d "${DST}" ] && removedata ${DST}
    [ -f "${JAILFSTAB}" ] && rm -f ${JAILFSTAB}
    [ -f "${JAILFSTAB}.local" ] && rm -f "${JAILFSTAB}.local"
    [ -f "${JAILRCCONF}" ] && rm -f ${JAILRCCONF}
    [ -d "${jailsysdir}/${jname}" ] && rm -rf "${jailsysdir}/${jname}"
done
