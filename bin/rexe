#!/bin/sh
#v9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG="node"
MYOPTARG="cmd"
MYDESC="Execute remote command by ssh"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
init $*

shift

NODECFG="${rsshdir}/${node}.node"
[ -f ${LOCALKEY} ] || err 1 "No node config found"
. ${NODECFG}
[ -f "${SSHKEY}" ] || err 1 "No node key found"

SSHOP="-oBatchMode=yes -oPort=${PORT} -oStrictHostKeyChecking=no -oConnectTimeout=5 -F ${sshdir}/config -q -i ${SSHKEY} ${cbsduser}@${IP}"

[ -n "$cmd" ] || cmd=${@}
[ -z "$cmd" ] && err 1 "Give me command"

ssh ${SSHOP} -C $cmd
[ $? -eq 0 ] || err 1 "ssh communication problem with ${ip}"

exit 0
