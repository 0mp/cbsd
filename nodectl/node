#!/bin/sh
#v9.2.2
globalconf="${workdir}/cbsd.conf";
MYARG="mode"
MYOPTARG="node port rootkeyfile pw"
MYDESC="Manipulate with remote nodes"
ADDHELP="mode = add , remove , list\n\
node = remote node ip or fqdn\n\
port = ssh port of remote node\n\
rootkeyfile = path to id_rsa for root access\n\
pw = password of cbsd user from remote node\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${tools}
. ${color}
. ${nodes}
init $*

nodeadd()
{
    [ -z "${node}" ] && err 1 "${MAGENTA}Empty node${NORMAL}"
    [ -z "${port}" ] && port=22222
    [ -z "${pw}" ] && err 1 "${MAGENTA}Empty pw${NORMAL}"
    [ -z "${rootkeyfile}" ] && rootkeyfile="/root/.ssh/id_rsa"

    if iptype $node; then
	resolvhost ${node}
	node=$HST
    fi

    NODENAME=`cbsd cbsdssh $node $port $cbsduser $pw cbsd getinfo -q nodename`

    case $? in
	0)
	    [ -z "$NODENAME" ] && err 1 "${MAGENTA}No nodename found. Check remote cbsd settings${NORMAL}"
	    ${ECHO} "${MAGENTA}${node} has nodename: ${GREEN}${NODENAME}${NORMAL}"
	;;
	1)
	    err 1 "${MAGENTA}Connection problem: ${GREEN}${node}${NORMAL}"
	;;
	2)
	    err 1 "${MAGENTA}Bad password or system user${NORMAL}"
	;;
    esac

    MD5NAME=`md5 -qs ${NODENAME}`
    cbsd nodeaddkey md5name=${MD5NAME} ip=${node} port=${port} pw=${pw} > $DEBLOG 2>&1

    case $? in
	0)
	    ${ECHO} "${MAGENTA}Added successfull: ${GREEN}${node}${NORMAL}"
	    LOCALKEY="${rsshdir}/${MD5NAME}.id_rsa"
	    sysrc -qf ${rsshdir}/${NODENAME}.node SSHKEY=$LOCALKEY > /dev/null
	    sysrc -qf ${rsshdir}/${NODENAME}.node IP=$node > /dev/null
	    sysrc -qf ${rsshdir}/${NODENAME}.node PORT=$port > /dev/null
	    A=`cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=get --nodename=${NODENAME} --param=ip`
	    if [ -z "${A}" ]; then
		cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=insert --nodename=${NODENAME} --ip=${node} --port=${port} --keyfile=${LOCALKEY} --rootkeyfile=$rootkeyfile --invfile=inv.${NODENAME}.sqlite
	    else
		${ECHO} "${MAGENTA}Already exist in database, updating: ${GREEN}${node}${NORMAL}"
		cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=delete --nodename=${NODENAME}
		cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=insert --nodename=${NODENAME} --ip=${node} --port=${port} --keyfile=${LOCALKEY} --rootkeyfile=$rootkeyfile --invfile=inv.${NODENAME}.sqlite
	    fi
	    idle_update ${NODENAME}
	    cbsd retrinv node=${NODENAME}
	;;
	1)
	    cat ${DEBLOG}
	    err 1 "${MAGENTA}Error: Bad password${NORMAL}"
	;;
	2)
	    cat ${DEBLOG}
	    err 1 "${MAGENTA}Error: No key found or wrong hostname. Make initenv on remote machine${NORMAL}"
	;;
	*)
	    cat ${DEBLOG}
	    err 1 "${MAGENTA}Error: Unkown error${NORMAL}"
	;;
    esac
}

nodedel()
{
    _descext="descr role domain notes location"

    [ -n "${node}" ] || err 1 "${MAGENTA}Empty node${NORMAL}"
    NODECONF="${rsshdir}/${node}.node"

    [ ! -f "${NODECONF}" ] && err 1 "${MAGENTA}No such node config: ${GREEN}${NODECONF}${NORMAL}"
    . ${NODECONF}

    [ -f ${SSHKEY} ] && rm -f ${SSHKEY}
    rm -f ${NODECONF}
    [ -f "${dbdir}/${node}.sqlite" ] && rm -f "${dbdir}/${node}.sqlite"
    cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=delete --nodename=${node}

    #descriptions die too
    find ${dbdir}/nodedescr -type f -depth 1 -maxdepth 1 -name ${node}.\*.descr -delete
    for i in ${_descext}; do
	[ -f "${dbdir}/nodedescr/${node}.${i}" ] && rm -f "${dbdir}/nodedescr/${node}.${i}"
    done

    ${ECHO} "${MAGENTA}Removed${NORMAL}"
}


case "${mode}" in
    "add")
	nodeadd
    ;;
    "remove")
	nodedel
    ;;
    "list")
	cbsd nodesql --dbfile=${dbdir}/nodes.sqlite --action=list
    ;;
    *)
	err 1 "${MAGENTA}Unknown mode${NORMAL}"
    ;;
esac
