#!/bin/sh
#v11.0.0
globalconf="${workdir}/cbsd.conf"
CBSDMODULE="bsdconf"
MYARG=""
MYOPTARG="jname"
MYDESC="cbsd pw wrapper"
ADDHELP="jname= work in with jail\n"
EXTHELP="modules/bsdconf.d.html"

set -e
. ${globalconf}
set +e

. ${subr}
. ${strings}
. ${system}
init $*

#defines
_MYDIR=$( /usr/bin/dirname `/bin/realpath $0` )

[ -n "${jname}" ] && shift # skip for jname

if [ -n "${fromfile}" ]; then
	shift
	[ -r "${fromfile}" ] && . ${fromfile}
fi

cmd="${@}"
[ -z "${cmd}" -a -z "${fromfile}" ] && err 1 "${MAGENTA}Empty command${NORMAL}"

## MAIN ##
if [ -n "${jname}" ]; then
	. ${jrcconf}
	[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

	[ $baserw -eq 1 ] && path=$data

	if [ ${jid} -eq 0 ]; then
		set -e
			. ${_MYDIR}/bsdconf.subr
		set +e
		. ${workdir}/universe.subr
		readconf buildworld.conf
		init_target_arch
		init_srcdir
		init_basedir
		init_kerneldir
		prepare_jail
	fi
	exec_cmd="/usr/sbin/chroot ${path} /usr/sbin/pw"
else
	data=""
	exec_cmd="/usr/sbin/pw"
fi

${exec_cmd} ${cmd}
