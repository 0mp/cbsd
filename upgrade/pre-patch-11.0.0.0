#!/bin/sh
#v10.1.0
# Rename arch to hostarch: via SQLdump, sed, export

unset workdir

# MAIN
. /etc/rc.conf

[ -z "${cbsd_workdir}" ] && exit

workdir="${cbsd_workdir}"

[ ! -f "${workdir}/cbsd.conf" ] && exit

. "${workdir}/cbsd.conf"

[ ! -f "${distdir}/etc/defaults/buildworld.conf" ] && exit
[ ! -f "${etcdir}/buildworld.conf" ] && exit

if grep ^arch= ${workdir}/nc.inventory >/dev/null 2>&1; then
	echo "  * Rename column arch to hostarch in local db"
	echo "    create backup of original base to /tmp/local.sqlite.$$"
	cp ${dbdir}/local.sqlite /tmp/local.sqlite.$$
	/usr/local/bin/sqlite3 ${dbdir}/local.sqlite ".dump local" > /tmp/replace_arch.$$
	sed -i '' s:arch:hostarch:g /tmp/replace_arch.$$
	/usr/local/bin/sqlite3 ${dbdir}/local.sqlite "DROP TABLE local"
	/usr/local/bin/sqlite3 ${dbdir}/local.sqlite < /tmp/replace_arch.$$
	rm -f /tmp/replace_arch.$$
fi
