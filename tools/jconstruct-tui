#!/bin/sh
#v9.2.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG=""
MYDESC="Ncurses based jail creation wizard"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${settingstui}
. ${color}
. ${dialog}

init $*

gen_newjail_conf()
{

local _i _required _mytest

    _required="jname fqdn ip4_addr ver arch"

    msg_ok="ok"

    for _i in ${_required}; do
	eval _mytest=\$$_i
	if [ -z "${_mytest}" ]; then
	    f_dialog_msgbox "${_i} must be not non-empty" "Error"
	    return 0
	fi
    done

    cbsd jconstruct-fromargs basename=$basename mdsize=$mdsize jname=$jname fqdn=$fqdn ip4_addr=$ip4_addr ver=$ver baserw=$baserw srcmount=$srcmount portsmount=$portsmount astart=$astart interface=$interface vnet=$vnet applytpl=$applytpl floatresolv=$floatresolv arch=$arch pkglist=$pkglist
    ERR=$?

    [ $ERR -eq 0 ] || err 1 "${MAGENTA}Bad conf${NORMAL}"
    err 0 ${A}
}


#### [ MAIN AREA ] ####
[ ! -f ${globalconf} ] && err 1 "${MAGENTA}no such conf file${NORMAL}"
. ${globalconf}

[ ! -f ${localcbsdconf} ] && err 1 "${MAGENTA}no such conf file${NORMAL}"
. ${localcbsdconf}
. ${inventory}

#defaults
. ${buildconf}

[ -z "${baserw}" ] && baserw=0
[ -z "${mdsize}" ] && mdsize=0
[ -z "${srcmount}" ] && srcmount=0
[ -z "${portsmount}" ] && portsmount=1
[ -z "${astart}" ] && astart=1
[ -z "${interface}" ] && interface="auto"
[ -z "${vnet}" ] && vnet=0
[ -z "${applytpl}" ] && applytpl=1
[ -z "${floatresolv}" ] && floatresolv=1

msg_ok="Ok"
msg_cancel="Cancel"

while [ 1 ]; do
    pkgnum=0
    [ -n "${pkglist}" -a "${pkglist}" != "NO" ] && pkgnum=`wc -l ${pkglist}|awk '{printf $1}'`

    menu_list="
    'pkglist' 'mark pkg for install from repo [$pkgnum]'
    'jname' 'A short jail name [${jname}]'
    'fqdn'  'Full (FQDN) jail hostname [$fqdn]'
    'ip4_addr' 'Assing IP address [$ip4_addr]'
    'ver' 'choose code base version [$ver]'
    'baserw'  'Jail base is not read-only [$baserw]'
    'portsmount' 'Mount for /usr/ports [$portsmount]'
    'astart'  'Auto start-up with system [$astart]'
    'interface' 'Interface selection and aliasing mode [$interface]'
    'applytpl'  'Apply cbsd templates [$applytpl]'
    'floatresolv' 'Auto correct for jail resolv.conf [$floatresolv]'
    'arch' 'target arch [$arch]'
    'GO' 'PROCEED!'
    "

    f_dialog_menu
    retval=$?
    f_dialog_menutag_fetch mtag
    case $retval in
	0)
	    [ $mtag = "pkglist" ] && get_pkglist
	    [ $mtag = "jname" ] && get_jname
	    [ $mtag = "fqdn" ] && get_jail_fqdn
	    [ $mtag = "ip4_addr" ] && get_jail_ips
	    [ $mtag = "ver" ] && get_jail_base
	    [ $mtag = "baserw" ] && get_jail_baserw
	    [ $mtag = "srcmount" ] && get_jail_srcmount
	    [ $mtag = "portsmount" ] && get_jail_portsmount
	    [ $mtag = "astart" ] && get_jail_astart
	    [ $mtag = "interface" ] && get_jail_oninterface
	    [ $mtag = "vnet" ] && get_jail_vnet
	    [ $mtag = "applytpl" ] && get_jail_applytpl
	    [ $mtag = "floatresolv" ] && get_jail_floatresolv
	    [ $mtag = "arch" ] && get_jail_arch
	    [ $mtag = "mdsize" ] && get_jail_mdsize
	    [ $mtag = "GO" ] && gen_newjail_conf
	    ;;
	*)
	    exit
	    ;;
    esac
done
