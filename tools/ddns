#!/bin/sh
#v9.1.0
globalconf="${workdir}/cbsd.conf";
MYARG="jname mode"
MYOPTARG=""
MYDESC="Update DDNS records for jail"
ADDHELP="mode=add,update or delete\n"

[ -f "${globalconf}" ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${system}
. ${zfstool}
. ${tools}
init $*

. ${buildconf}

JAILRCCONF="${jailrcconfdir}/rc.conf_${jname}"

[ -f  ${JAILRCCONF} ] || {
    echo "no conf rc.conf file for ${jname}"
    continue
}
. ${JAILRCCONF}
[ -z "${ddns_zone_list}" ] && err 1 "Please set ddns_zone_list"

for e in ${ddns_zone_list}; do
    eval zonekey=\"\$ddns_key_${e}\"
    eval zones=\"\$ddns_zones_${e}\"
	[ -z "${zonekey}" ] && {
	    echo "Empty ddns_key_${e}"
	    continue
	}

	[ ! -f "${zonekey}" ] && {
	    echo "No such zone key ${e}. Use ddns_key_${e}= in rc.conf"
	    continue
	}

	[ -z "${zones}" ] && {
	    echo "Empty zones for ddns_zones_${e}"
	    continue
	}

    for a in ${zones}; do
	for ip in ${ip4_addr}; do
	    ipwmask $ip
	    iptype $IWM
	    case $? in
		2) TYPE="IN AAAA" ;;
		*) TYPE="IN A" ;;
	    esac
	    printf "update ${mode} ${a}. 10 ${TYPE} ${IWM}\nsend\nquit\n" | nsupdate -k ${zonekey}
	done
    done
done
