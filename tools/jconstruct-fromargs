#!/bin/sh
#v9.2.2
globalconf="${workdir}/cbsd.conf";
MYARG="jname fqdn ip4_addr"
MYOPTARG="ver mdsize basename baserw mount_src mount_ports astart interface vnet applytpl floatresolv arch inter pkglist vnet"
MYDESC="jail create by shell args"
ADDHELP="inter=0 to prevent any questions and to accept answers by default\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${color}

init $*

gen_newjail_conf()
{
    DT=`date "+%Y%m%d_%H_%M"`
    TMPFILE="${ftmpdir}/${DT}-${jname}.jconf"
    data="${jaildatadir}/${jname}-${jaildatapref}"
    rootdir="${jaildir}/${jname}"
    fstab="${jailfstabdir}/${jailfstabpref}${jname}"
    rcconf="${jailrcconfdir}/rc.conf_${jname}"

    cat > ${TMPFILE} << EOF
# DO NOT EDIT THIS FILE. PLEASE USE INSTEAD:
# cbsd jconfig jname=${jname}
jname="${jname}";
path="${rootdir}";
host_hostname="${fqdn}";
ip4_addr="${ip4_addr}";
mount_devfs="1";
allow_mount="1";
allow_devfs="0";
allow_nullfs="0";
mount_fstab="${fstab}";
arch="${arch}";
mkhostsfile="1";
devfs_ruleset="4";
ver="${ver}";
basename="${basename}";
slavenode="0";
baserw="$baserw";
basename="$basename";
mount_src="$mount_src";
mount_obj="$mount_obj";
mount_kernel="0";
mount_ports="$mount_ports";
astart="$astart";
data="${data}";
vnet="$vnet";
applytpl="${applytpl}";
mdsize="${mdsize}";
rcconf="${jailrcconfdir}/rc.conf_${jname}";
floatresolv="${floatresolv}";
exec_start="/bin/sh /etc/rc";
exec_stop="/bin/sh /etc/rc.shutdown";

exec_poststart="0";
exec_poststop="0";
exec_prestart="0";
exec_prestop="0";

exec_master_poststart="0";
exec_master_poststop="0";
exec_master_prestart="0";
exec_master_prestop="0";
EOF

    if [ "${interface}" = "0" ]; then
	echo "interface=\"0\";" >> ${TMPFILE}
    else
	echo "interface=\"${interface}\";" >> ${TMPFILE}
    fi

    [ -n "${pkglist}" ] && echo "pkglist=\"${pkglist}\";" >> ${TMPFILE}

    getyesno "${MAGENTA}Do you want to create jail immediately?${NORMAL}"
    [ $? -eq 1 -o $? -eq 3 ] && err 0 "${MAGENTA}You can make now: ${GREEN}cbsd jcreate jconf=${TMPFILE}${NORMAL}"
    cbsd jcreate jconf=${TMPFILE}
    [ $? -ne 0 ] && err 0 "${MAGENTA}Config file for jconf: ${GREEN}${TMPFILE}${NORMAL}"
    return 0
}

#### [ MAIN AREA ] ####
[ ! -f ${localcbsdconf} ] && err 1 "no such conf file"
. ${localcbsdconf}

#defaults
. $buildconf

[ -z "${baserw}" ] && baserw=0
[ -z "${mdsize}" ] && mdsize=0
[ -z "${mount_src}" ] && mount_src=0
[ -z "${mount_ports}" ] && mount_ports=1
[ -z "${astart}" ] && astart=1
[ -z "${interface}" ] && interface=1
[ -z "${vnet}" ] && vnet=0
[ -z "${applytpl}" ] && applytpl=1
[ -z "${floatresolv}" ] && floatresolv=1

gen_newjail_conf
