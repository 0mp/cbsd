#!/bin/sh
#v9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG="jname fqdn ips vnet"
MYOPTARG="base baserw srcmount portsmount astart oninterface vnet applytpl floatresolv arch"
MYDESC="jail create by shell args"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
init $*

gen_newjail_conf()
{
DT=`date "+%Y%m%d_%H_%M"`
TMPFILE="${tmpdir}/${DT}-${jname}.jconf"
data="${jaildatadir}/${jname}-${jaildatapref}"
rootdir="${jaildir}/${jname}"
fstab="${jailfstabdir}/${jailfstabpref}${jname}"
rcconf="${jailrcconfdir}/rc.conf_${jname}"

cat > ${TMPFILE} << EOF
jail_list="${jname}"
jail_${jname}_rootdir="${rootdir}"
jail_${jname}_hostname="${fqdn}"
jail_${jname}_ip="${ips}"
jail_${jname}_devfs_enable="YES"
jail_${jname}_mount_enable="YES"
jail_${jname}_fstab="${fstab}"
jail_${jname}_arch="${arch}"
jname="$jname"
jail_${jname}_base="${base}"
jail_${jname}_baserw="$baserw"
jail_${jname}_basename=""
jail_${jname}_srcmount="$srcmount"
jail_${jname}_objmount="$objmount"
jail_${jname}_portsmount="$portsmount"
jail_${jname}_astart="$astart"
jail_${jname}_data="${data}"
jail_${jname}_vnet="$vnet"
jail_${jname}_applytpl="${applytpl}"
jail_${jname}_floatresolv="${floatresolv}"
jail_${jname}_rcconf="${jailrcconfdir}/rc.conf_${jname}"
jail_${jname}_exec_start="/bin/sh /etc/rc"
jail_${jname}_exec_stop="/bin/sh /etc/rc.shutdown"
jail_${jname}_exec_afterstart0=""
jail_${jname}_exec_prestart0=""
jail_${jname}_master_afterstart0=""
jail_${jname}_master_prestart0=""
jail_${jname}_exec_afterstop0=""
jail_${jname}_exec_prestop0=""
jail_${jname}_master_afterstop0=""
jail_${jname}_master_prestop0=""
jail_${jname}_mkhostsfile="1"
jail_${jname}_devfsrules_jail="4"
EOF

if [ $oninterface -eq 1 ]; then
A=`cbsd getnics-by-ip ip=$ips`
if [ -n "${A}" ]; then
cat >> ${TMPFILE} << EOF
jail_${jname}_interface="${A}"
EOF
fi
fi

err 0 "You can make now: cbsd jcreate jconf=${TMPFILE}"
}

#### [ MAIN AREA ] ####
if [ ! -f ${localcbsdconf} ]; then
err 1 "no such conf file"
fi
. ${localcbsdconf}

#defaults
[ -z "${base}" ] && base=`uname -r|cut -d "-" -f1 |tr "." "_"`
[ -z "${baserw}" ] && baserw=0
[ -z "${srcmount}" ] && srcmount=0
[ -z "${portsmount}" ] && portsmount=1
[ -z "${astart}" ] && astart=1
[ -z "${oninterface}" ] && oninterface=1
[ -z "${vnet}" ] && vnet=0
[ -z "${applytpl}" ] && applytpl=1
[ -z "${floatresolv}" ] && floatresolv=1
[ -z "$arch" ] && arch=`uname -m`

gen_newjail_conf
