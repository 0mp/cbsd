#!/bin/sh
#v9.2.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="out jname pkgdbdir portname conf"
MYDESC="Show installed 'leaf' packages, that not referenced by any port"
ADDHELP="out=filename - update mode, redirect output to out=filename\n\
jname=jname info for jail jname\n\
pkgdbdir= use this path for info instead of query by jname\n\
filter= - additional argument to pkg info\n\
portname=nameport - query for nameport only\n\
conf= alternative path to conf, default is workdir/etc/pkg_cutleaves.conf\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
init $*

[ -z "${conf}" ] && conf="${etcdir}/pkg_cutleaves.conf"
[ -z "${filter}" ] && filter=""
[ -z "${portname}" ] && portname=""

SKIPPORT=""
[ -f "${conf}" ] && . ${conf}


if [ -n "${jname}" ]; then
    JAILRCCONF="${jailrcconfdir}/rc.conf_${jname}"
    [ -f  "${JAILRCCONF}" ] || err 1 "no conf rc.conf file for jail"
    . ${JAILRCCONF}
    DBDIR="${data}/var/db/pkg"
else
    if [ -n "${pkgdbdir}" ]; then
	DBDIR="${pkgdbdir}"
    else
	DBDIR="/var/db/pkg"
    fi
fi

if [ -n "${out}" ]; then
    [ ! -d `dirname ${out}` ] && mkdir -p `dirname ${out}`
    truncate -s0 ${out}
fi

[ -z "${out}" ] && out="/dev/stdout"
[ -d "${DBDIR}" ] || err 1 "No such pkg pkgdbdir"

for i in `env PKG_DBDIR="${DBDIR}" /usr/sbin/pkg info -oqa`; do
    A=`pkg query "%ro" $i`
    SKIP=0
        for n in ${SKIPPORT}; do
            [ `echo $i | grep ${n}|wc -l` != 0 ] && SKIP=1
        done
    [ -z "${A}" -a "${SKIP}" = "0" ] && printf "/usr/ports/$i\n" >> ${out}
done
