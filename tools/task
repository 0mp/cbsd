#!/usr/local/bin/cbsd
#v10.0.6
MYARG="mode"
MYOPTARG="logfile notify autoflush node"
MYDESC="Task queue management"
CBSDMODULE="taskd"
ADDHELP="mode=new <cmd>, mode=cancel <jobid>, mode=cancelall, mode=flushall\n\
notify=0 for prevent notification of result to email\n\
autoflush=0,1,2 (0 - all jobs stored in base, 1 - autoflush completed cmd, 2 - autoflush for all cm)\n"

EXTHELP="wf_taskd.html"

. ${subr}
. ${inventory}
. ${system}
. ${color}
. ${strings}

init $*


try_remote()
{

#if check_locktime /usr/jails/ftmp/shmux_199.48.133.74.lock; then
#    echo "OK"
#fi

echo "NODE: ${node}"
echo "TASK STR: $@"
owner="${nodename}"
echo "OWNER: ${owner}"


exit 0
}




## MAIN
[ -n "${logfile}" ] && shift
[ -n "${notify}" ] && shift
[ -n "${autoflush}" ] && shift
[ -n "${node}" ] && shift

shift ## mode=xxx

## place for default of all variables for remote node?
[ -z "${notify}" ] && notify=1
[ -n "${node}" ] && try_remote $@


case "${mode}" in
    "new")
	[ -z "$1" ] && err 1 "${MAGENTA}Command required${NORMAL}"
	if [ -n "${logfile}" ]; then
	    _err=$( cbsdsql cbsdtaskd "INSERT INTO taskd ( cmd,status,logfile,logtype,notify,autoflush ) VALUES ( \"$@\", 0, \"$logfile\", 0, \"$notify\", \"$autoflush\" )" )
	else
	    _err=$( cbsdsql cbsdtaskd "INSERT INTO taskd ( cmd,status,notify,autoflush ) VALUES ( \"$@\", 0, \"$notify\", \"$autoflush\" )" )
	fi
	[ $? -ne 0 ] && err 1 "${MAGENTA}Error: ${_err}${NORMAL}"
	tid=$( cbsdsql cbsdtaskd "SELECT id FROM taskd WHERE cmd=\"$@\" AND status=0 ORDER BY id DESC LIMIT 1" )
	[ -z "${tid}" ] && err 1 "${MAGENTA}Error: ${_err}${NORMAL}"
	${ECHO} "${MAGENTA}Queued: ${GREEN}${tid}${NORMAL}"
	;;
    "cancel")
    ;;
    "cancelall")
    ;;
    "flushall")
	for i in $( cbsdsql cbsdtaskd SELECT logfile FROM taskd WHERE status='2' ); do
	    [ -f "${i}" ] && rm -f "${i}"
	done
	cbsdsql cbsdtaskd DELETE FROM taskd WHERE status='2'
	;;
esac
