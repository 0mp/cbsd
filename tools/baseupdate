#!/usr/local/bin/cbsd
#v10.1.0
MYARG=""
MYOPTARG="name arch targetarch ver"
MYDESC="Update base jail"
CBSDMODULE="sys"
ADDHELP="name= base to update\n\
arch= architecture\n\
targetarch= target architecture\n\
ver= current version\n"

. ${subr}
. ${system}
. ${strings}
. ${tools}

init $*

update_base()
{
	local _i
	sqlfile="local"
	update_conf="${1}"

	_sql="SELECT platform,name,arch,targetarch,ver,stable,elf,status,date FROM bsdbase"
	cbsdsql ${sqlfile} ${_sql}| while read _platform _name _arch _targetarch _ver _stable _elf _status _date; do
		base="${name}_${arch}_${targetarch}_${ver}"
		if [ "${base}" = "${_name}_${_arch}_${_targetarch}_${_ver}" ]; then
			basepath=${workdir}/base/${base}
			if [ -e "${basepath}/usr/sbin/hbsd-update" ]; then
				hbsd-update -r "${basepath}"
			else
				FBSD_UPDATE="freebsd-update -f ${update_conf} -b ${basepath} --not-running-from-cron"
				env PAGER=cat ${FBSD_UPDATE} fetch
				${FBSD_UPDATE} install
			fi
		fi
	done
}

sqldelimer=" "

update_conf=`mktemp`
cat << EOF > "${update_conf}"
KeyPrint 800651ef4b4c71c27e60786d7b487188970f4b4169cc055784e21eb71d410cc5
ServerName update.FreeBSD.org
Components world
IgnorePaths
IDSIgnorePaths /usr/share/man/cat
IDSIgnorePaths /usr/share/man/whatis
IDSIgnorePaths /var/db/locate.database
IDSIgnorePaths /var/log
UpdateIfUnmodified /etc/ /var/ /root/ /.cshrc /.profile
MergeChanges /etc/ /boot/device.hints
EOF

update_base "${update_conf}"
rm -rf "${update_conf}"
