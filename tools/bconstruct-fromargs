#!/bin/sh
#v10.0.4
globalconf="${workdir}/cbsd.conf";
MYARG="jname fqdn ip4_addr freesize"
MYOPTARG="ver basename baserw mount_src mount_ports astart interface vnet applytpl floatresolv arch inter pkglist vm_cpus vm_ram vm_os_type gw4 vm_os_profile"
MYDESC="jail create by shell args"
ADDHELP="inter=0 to prevent any questions and to accept answers by default\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${color}
readconf jail.conf

init $*

gen_newjail_conf()
{
    DT=`date "+%Y%m%d_%H_%M"`
    TMPFILE="${ftmpdir}/${DT}-${jname}.jconf"
    data="${jaildatadir}/${jname}-${jaildatapref}"
    rootdir="${jaildir}/${jname}"
    fstab="${jailfstabdir}/${jailfstabpref}${jname}"
    rcconf="${jailrcconfdir}/rc.conf_${jname}"

# original jail area
cat > ${TMPFILE} << EOF
# DO NOT EDIT THIS FILE. PLEASE USE INSTEAD:
# cbsd jconfig jname=${jname}
jname="${jname}";
path="${rootdir}";
host_hostname="${fqdn}";
ip4_addr="${ip4_addr}";
mount_devfs="1";
allow_mount="1";
allow_devfs="0";
allow_nullfs="0";
mount_fstab="${fstab}";
arch="${arch}";
mkhostsfile="1";
devfs_ruleset="4";
ver="${ver}";
basename="${basename}";
baserw="0";
mount_src="0";
mount_obj="0";
mount_kernel="0";
mount_ports="0";
astart="${astart}";
data="${data}";
vnet="0";
applytpl="${applytpl}";
mdsize="0";
rcconf="${jailrcconfdir}/rc.conf_${jname}";
floatresolv="${floatresolv}";

exec_poststart="0";
exec_poststop="0";
exec_prestart="0";
exec_prestop="0";

exec_master_poststart="0";
exec_master_poststop="0";
exec_master_prestart="0";
exec_master_prestop="0";
EOF


# bhyve area
    cat >> ${TMPFILE} << EOF
emulator="bhyve";
freesize="${freesize}";
vm_cpus="${vm_cpus}";
vm_ram="${vm_ram}";
vm_os_type="${vm_os_type}";
dist_site="";
iso_site="";
iso_img="";

vm_hostbridge="${vm_hostbridge}";
bhyve_flags="${bhyve_flags}";
virtio_type="${virtio_type}";
gw4="${gw4}";
vm_os_profile="${vm_os_profile}";
EOF

    [ -n "${pkglist}" ] && echo "pkglist=\"${pkglist}\";" >> ${TMPFILE}

    getyesno "${MAGENTA}Do you want to create vm immediately?${NORMAL}"
    [ $? -eq 1 -o $? -eq 3 ] && err 0 "${MAGENTA}You can make now: ${GREEN}cbsd bcreate jconf=${TMPFILE}${NORMAL}"
    cbsd bcreate jconf=${TMPFILE} delpkglist=1 removejconf=1
    [ $? -ne 0 ] && err 0 "${MAGENTA}Config file for jconf: ${GREEN}${TMPFILE}${NORMAL}"
    return 0

}

#### [ MAIN AREA ] ####
[ ! -f ${localcbsdconf} ] && err 1 "no such conf file"
. ${localcbsdconf}

#defaults
#. $buildconf

[ -z "${baserw}" ] && baserw=0
[ -z "${astart}" ] && astart=1
[ -z "${interface}" ] && interface=1
[ -z "${applytpl}" ] && applytpl=1
[ -z "${floatresolv}" ] && floatresolv=1

# profile
if [ -n "${vm_os_profile}" ]; then
	readconf bhyve-${vm_os_type}-${vm_os_profile}.conf
	[ -z "${bhyve_profile}" ] && err 1 "${MAGENTA}No such profile: ${GREEN}bhyve-${vm_os_type}-${vm_os_profile}.conf${NORMAL}"
fi

# escapes. todo: for all data?
#grub_iso_cmd=$( echo $grub_iso_cmd | sed s:\":\\\\\":g )
#grub_boot_cmd=$( echo $grub_boot_cmd | sed s:\":\\\\\":g )


gen_newjail_conf
