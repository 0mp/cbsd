#!/bin/sh
#v9.2.1
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="out repo conf"
MYDESC="Generate choosen package list from repository"
ADDHELP="out=path_to_file with result, instead of random\n\
repo= use this repository\n\
conf= use this pkg.conf\n"

[ -f "${globalconf}" ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${tools}
. ${color}

init $*

[ -z "${out}" ] && out="${ftmpdir}/pkgbrowser.$$"
tmp1="${ftmpdir}/pkgmytmp1.$$"
tmp2="${ftmpdir}/pkgmytmp2.$$"

DIALOG=${DIALOG=/usr/bin/dialog}

truncate -s0 ${tmp1} ${tmp2}

PKGCONF=""
PKGOPT=""

if [ -n "${repo}" ]; then
    PKGCONF="${ftmpdir}/mypkg.conf.$$"
    echo "PACKAGESITE: ${repo}" > ${PKGCONF}
    trap "rm -f ${tmp1} ${tmp2} ${PKGCONF}" 0 1 2 3 4 5 9
elif [ -n "${conf}" ]; then
    [ -f "${conf}" ] && PKCONF="${conf}"
fi

[ -z "${PKGCONF}" -a -f "/usr/local/etc/pkg.conf" ] && PKGCONF="/usr/local/etc/pkg.conf"
#[ -z "${PKGCONF}" ] && err 0 "${MAGENTA}No such valid configuration${NORMAL}"

[ -z "${PKGCONF}" ] && PKGOPT="-C ${PKGCONF}"

printf "${MAGENTA}Building pkg list${NORMAL}"
LIST=`pkg ${PKGOPT} rquery "%n-%v"`

[ $? -ne 0 ] && err 1 "${MAGENTA}Repository not configured or network error${NORMAL}"

for i in ${LIST}; do
    A=`pkg ${PKGOPT} query "%ro" $i`
    [ -z "${A}" ] &&  dot "pkg ${PKGOPT} query" && echo $i >> ${tmp1}
done

printf "${GREEN}done${NORMAL}\r\n${MAGENTA}Sorting...${NORMAL}\r\n"

cat > $tmp2 << EOF
--colors --backtitle "\Z1Select packages" --separate-output --title "Select packages" --checklist "Use space for mark packages \n" 0 61 0
EOF

sort -u $tmp1 | \
    while read _p; do
#	CATEGORY=`pkg rquery \"%C\" $_p | xargs`
#	[ "${CATEGORY}"  = "local" ] && continue
#	[ -z "$CATEGORY" ] && 
#	CATEGORY=$_p
	echo "\"$_p\" \"\" off \ " >> ${tmp2}
    done

${DIALOG} --file ${tmp2} 2>$out

[ $? -ne 0 -o `wc -l ${out}|awk '{printf $1}'` = "0" ] && rm -f ${out} && err 1 "${MAGENTA}No pkg selected${NORMAL}"

echo $out
