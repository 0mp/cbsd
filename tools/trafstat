#!/usr/local/bin/cbsd
#v10.1.0
MYARG=""
MYOPTARG="mode jname"
MYDESC="Show traffic statistics for the jail"
ADDHELP=""

. ${subr}
. ${inventory}
. ${system}
. ${strings}
. ${tools}
init $*

jaillist=$( cbsdsql local SELECT jname FROM jails )

# return 1 if no traffic stats
init_jail_dbpath()
{
	TRAFDIR="${jailsysdir}/${jname}/traffic"
	CURDATE=$( date "+%Y-%m" )
	TRAFFILE="${TRAFDIR}/${CURDATE}.sqlite"

	[ ! -f "${TRAFFILE}" ] && return 1
	return 0
}

jail_in_month()
{
	header="${BOLD}Time|Incoming bytes|Outgoing bytes${NORMAL}"
	trafdata=$( /usr/local/bin/sqlite3 ${TRAFFILE} "SELECT * FROM traffic" )

	${ECHO} "${header}\n${trafdata}"| /usr/bin/column -s "|" -t
}

jail_in_month_summary()
{
	sum_in=$( /usr/local/bin/sqlite3 ${TRAFFILE} 'SELECT sum(incoming) FROM traffic' )
	sum_out=$( /usr/local/bin/sqlite3 ${TRAFFILE} 'SELECT sum(outgoing) from traffic' )

	if conv2human "${sum_in}"; then
		sum_in=${convval}
	fi

	if conv2human "${sum_out}"; then
		sum_out=${convval}
	fi

	${ECHO} "${MAGENTA}Incoming: ${GREEN}${sum_in}${NORMAL}"
	${ECHO} "${MAGENTA}Outgoing: ${GREEN}${sum_out}${NORMAL}"
}

jail_in_month_summary_header()
{
	CURDATE=$( date "+%Y-%m" )
	${ECHO} "${BOLD}Summary traffic stats for ${jname} in ${CURDATE} ${NORMAL}"
	${ECHO} "${BOLD}=================================================${NORMAL}"
}

if [ -z "${jname}" ]; then
	summary=1
else
	jaillist="${jname}"
	summary=0
fi

for jname in ${jaillist}; do
	init_jail_dbpath || continue
	[ ${summary} -eq 0 ] && jail_in_month
	jail_in_month_summary_header
	jail_in_month_summary
done
