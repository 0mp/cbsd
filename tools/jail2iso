#!/bin/sh
#v10.0.3
globalconf="${workdir}/cbsd.conf"
MYARG="jname dstdir media"
MYOPTARG="name label product publisher prunelist imgsize"
MYDESC="Convert jail into cd9660 ISO or memstick image"
ADDHELP="dstdir= destination dir for storing jname.iso\n\
name - for alternative kernel name (GENERIC is default)\n\
label - label for media\n\
media - iso,memstick or bhyve\n\
prunelist= path to prunelist, default is ${sharedir}/jail2iso-prunelist\n\
imgsize= reserved for X size (100m, 1g) for images (primarily for bhyve img)\n"
EXTHELP="html/wf_jail2iso_en.html"

[ -f "${globalconf}" ] || err 1 "no such conf file"
. ${globalconf}
. ${subr}
. ${inventory}
. ${system}
. ${zfstool}
. ${color}
. ${strings}
readconf buildworld.conf
. ${workdir}/universe.subr

init $*

. ${buildconf}
. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

init_target_arch
init_srcdir
init_supported_arch
init_basedir
init_kerneldir

#must be upper registry? :
LABEL="CBSD"
PRODUCT="cbsd jail2iso"
PUBLISHER="The CBSD Project. http://www.bsdstore.ru"

[ -n "${label}" ] && LABEL="${label}"
[ -n "${product}" ] && PRODUCT="${product}"
[ -n "${publisher}" ] && PUBLISHER="${publisher}"
[ -n "${imgsize}" ] && IMGSIZE="-s ${imgsize}"

TMP_DIR="${tmpdir}/$jname-iso"
DST_DIR="${tmpdir}/tmpmfsroot"

TRAP=""

clear_tmp_dir()
{
    [ -d "${TMP_DIR}" -o -f "${TMP_DIR}" ] && chflags -R noschg ${TMP_DIR} && rm -rf ${TMP_DIR}
}

make_mtree()
{
    [ -f ${BASE_DIR}/etc/mtree/BSD.root.dist ] && mtree -deU -f ${BASE_DIR}/etc/mtree/BSD.root.dist -p ${DST_DIR} >/dev/null
    [ -f ${BASE_DIR}/etc/mtree/BSD.usr.dist ] && mtree -deU -f ${BASE_DIR}/etc/mtree/BSD.usr.dist -p ${DST_DIR}/usr >/dev/null
    [ -f ${BASE_DIR}/etc/mtree/BSD.var.dist ] && mtree -deU -f ${BASE_DIR}/etc/mtree/BSD.var.dist -p ${DST_DIR}/var >/dev/null
    [ -f ${BASE_DIR}/etc/mtree/BIND.chroot.dist ] && mtree -deU -f ${BASE_DIR}/etc/mtree/BIND.chroot.dist -p ${DST_DIR}/var/named >/dev/null
    [ -f ${BASE_DIR}/etc/mtree/BSD.sendmail.dist ] && mtree -deU -f ${BASE_DIR}/etc/mtree/BSD.sendmail.dist -p ${DST_DIR} >/dev/null
}

make_libmap()
{
    A=`mktemp /tmp/libtxt.XXX`
    B=`mktemp /tmp/libtxtsort.XXX`
    TRAP="${TRAP} rm -f ${A} ${B};"
    trap "${TRAP}" HUP INT ABRT BUS TERM EXIT

    cat ${FILES} |while read line; do
	[ -z "${line}" ] && continue
	case ":${line}" in
	    :#*)
		continue
		;;
	esac
	ldd -f "%p\n" ${BASE_DIR}${line} >> $A 2>/dev/null
    done

    sort -u ${A} > ${B}
}

copy_binlib()
{
    cat ${FILES}| while read line; do
	[ -z "${line}" ] && continue
	case ":${line}" in
	    :#*)
		continue
		;;
	esac
	D=`chroot ${BASE_DIR} dirname ${line}`
	rsync -av ${BASE_DIR}${line} ${DST_DIR}${D}
	A=`readlink ${BASE_DIR}${line}`
	if [ -n "${A}" -a -f "${D}/${A}" ]; then
	    echo "SYM: $A"
	    rsync -av -${D}${A} ${DST_DIR}${D}
	fi
    done

    cat ${B}| while read line; do
	[ -z "${line}" ] && continue
	D=`chroot ${BASE_DIR} dirname ${line}`
	rsync -avzx ${BASE_DIR}${line} ${DST_DIR}${D}
    done

    rm -f ${A} ${B}
}


# Prepare MFSRoot part
prepare_dir()
{
    local rcscript="/etc/rc.d/preparedir"

    cp -rP ${path}/etc ${DST_DIR}/

    case "${media}" in
    "iso")
	MOUNTROOT="/sbin/mount -oro -t cd9660 /dev/iso9660/${LABEL} /mnt"
	;;
    "memstick")
	MOUNTROOT="/sbin/mount -oro /dev/ufs/${LABEL} /mnt"
	;;
    esac

cat > ${DST_DIR}${rcscript} <<EOF
#!/bin/sh
#
# Copyright (c) 2014 Oleg Ginzburg <olevole@olevole.ru>

# PROVIDE: preparedir
# KEYWORD: nojail
# BEFORE: sysctl

MOUNTOK=0
maxretry=10
retry=0

if [ ! -d /mnt/bin ]; then
    printf "Waiting ${maxretry}s for mount root..."
    while [ \$MOUNTOK -ne 1 ]; do
	${MOUNTROOT} 2>/dev/null
	if [ \$? -ne 0 ]; then
	    printf " \${retry} "
	    sleep 1
	    retry=\$((retry+1))
	else
	    echo
	    MOUNTOK=1
	fi
	
	if [ \$retry -ge \${maxretry} ]; then
	    echo
	    echo "Unsuccess. Drop to single mode"
	    exit
	fi
    done
fi

if [ ! -d /usr/bin ]; then
EOF
    echo 'MD=$(/sbin/mdconfig -o noreadonly -a -t vnode -f /mnt/usr.uzip)' >> ${DST_DIR}${rcscript}
    echo '/sbin/mount -oro /dev/${MD}.uzip /mnt/usr' >> ${DST_DIR}${rcscript}
    echo '/sbin/mount -oro -t nullfs /mnt/usr /usr' >> ${DST_DIR}${rcscript}
    echo '/sbin/mount -oro -t nullfs /mnt/boot /boot' >> ${DST_DIR}${rcscript}
    echo 'hash -r' >> ${DST_DIR}${rcscript}
    echo 'fi' >>${DST_DIR}${rcscript}

    chmod 0555 ${DST_DIR}${rcscript}

    cp ${path}/etc/rc.conf ${DST_DIR}/etc/rc.conf

    # Here is mfsroot location
    if [ -f "${jailsysdir}/${jname}/tmpfsdir" ]; then
	cp ${miscdir}/tmpfsdir ${DST_DIR}/etc/rc.d/
    fi
}

prunelist()
{

    [ ! -f "${prunelist}" ] && return 0 # no prune
    [ -z "${1}" ] && return 0 # sanity

    ${ECHO} "${MAGENTA}Prune file by list: ${GREEN}${prunelist}${NORMAL}"

    for FILE in `cat ${prunelist}`; do
	[ -z "${FILE}" ] && continue
	case ":${FILE}" in
	    :#* | :)
		continue
		;;
	esac
	rm -rf ${1}/${FILE} 2>/dev/null
    done
}


makemfsroot()
{
    dd if=/dev/zero of=/tmp/mfsroot count=40000 bs=1k

    DEV=`mdconfig -a -t vnode -f /tmp/mfsroot`
    bsdlabel -w /dev/${DEV} auto
    newfs -n -i ${BS} -m 0 -o space /dev/${DEV}
    mkdir -p ${DST_DIR}
    mount /dev/${DEV} ${DST_DIR}
    make_mtree
    make_libmap
    copy_binlib
    prepare_dir
    prunelist ${DST_DIR}
    cd /
    # make flags for preparedir script
    [ -d "${DST_DIR}/usr/bin" ] && rm -rf ${DST_DIR}/usr/bin
    umount -f ${DST_DIR} && rmdir ${DST_DIR}
    mdconfig -d -u ${DEV}
    gzip -9 /tmp/mfsroot
}


# MAIN
clear_tmp_dir
[ $baserw -eq 1 ] && path=$data

[ -z "${prunelist}" ] && prunelist="${sharedir}/jail2iso-prunelist"

[ ! -d "${KERNEL_DIR}" ] && err 1 "No such ${KERNEL_DIR}"
[ "$media" = "iso" -o "$media" = "memstick" -o "${media}" = "bhyve" ] || err 1 "${MAGENTA}Unknown media type. Must be: ${GREEN}iso${MAGENTA},${GREEN} memstick ${MAGENTA}or${GREEN} bhyve${NORMAL}"
mountbase -o "" -p "" -d "" -c "" -s ""
[ "${ver}" != "empty" ] && cbsd mountfstab jroot=${path} fstab=${mount_fstab} > /dev/null 2>&1
FILES="${sharedir}/defbase_${ver}.txt"
[ ! -f "${FILES}" ] && err 1 "No such default base listing: ${FILES}"
BS=8192

[ "${media}" != "bhyve" ] && makemfsroot

TRAP="${TRAP} clear_tmp_dir;"
trap "${TRAP}" HUP INT ABRT BUS TERM EXIT
cp -a ${path} ${TMP_DIR}

[ "${media}" != "bhyve" ] && rm -rf ${TMP_DIR}/rescue

prunelist ${TMP_DIR}

# remove archive
find ${TMP_DIR} -type f -name \*.a -delete

cp -a ${KERNEL_DIR}/boot/kernel ${TMP_DIR}/boot
rm -f ${TMP_DIR}/boot/kernel/*.symbols
cd ${TMP_DIR}/boot/kernel && gzip -9 ./kernel

if [ -f "$jailsysdir/${jname}/loader.conf" ]; then
    cp ${jailsysdir}/${jname}/loader.conf ${TMP_DIR}/boot/loader.conf
fi

if [ "${media}" != "bhyve" ]; then
cat >> ${TMP_DIR}/boot/loader.conf << EOF
geom_uzip_load="YES"
tmpfs_load="YES"
nullfs_load="YES"

mfs_load="YES"
mfs_type="mfs_root"
mfs_name="/mfsroot"
vfs.root.mountfrom="ufs:/dev/md0"

net.inet.ip.fw.default_to_accept=1
EOF
else
cat >> ${TMP_DIR}/boot/loader.conf <<EOF
console="userboot"
EOF
fi

case "${media}" in
"iso")
    ROOTFS="/dev/iso9660/${LABEL} /mnt cd9660 ro 0 0"
    ;;
"memstick")
    ROOTFS="/dev/ufs/${LABEL} /mnt ufs ro,noatime 1 1"
    ;;
"bhyve")
    ROOTFS="/dev/vtbd0 / ufs rw 1 1"
    ;;
esac

if [ "${media}" != "bhyve" ]; then
cat > ${TMP_DIR}/etc/fstab << EOF
tmpfs /tmp tmpfs rw 0 0
${ROOTFS}
/mnt/boot /boot nullfs ro 0 0
tmpfs /boot/zfs tmpfs rw 0 0
EOF
else
cat > ${TMP_DIR}/etc/fstab <<EOF
${ROOTFS}
EOF
fi

echo "Welcome to ${PRODUCT}" > ${TMP_DIR}/etc/motd

if [ "${media}" != "bhyve" ]; then
    mv /tmp/mfsroot.gz ${TMP_DIR}
    #mkuzip
    TRAP="${TRAP} rm -f /tmp/usr.img.$$ ;"
    trap "${TRAP}" HUP INT ABRT BUS TERM EXIT
    makefs -o optimization=space -t ffs /tmp/usr.img.$$ ${TMP_DIR}/usr
    mkuzip -o ${TMP_DIR}/usr.uzip /tmp/usr.img.$$
    chflags -R noschg ${TMP_DIR}/usr && rm -rf ${TMP_DIR}/usr && mkdir ${TMP_DIR}/usr
    #

    # LiveCD location
    if [ -f "$jailsysdir/${jname}/tmpfsdir" ]; then
	cp ${jailsysdir}/${jname}/tmpfsdir ${TMP_DIR}/etc/
    #    cp ${miscdir}/tmpfsdir ${TMP_DIR}/etc/rc.d/
    fi
fi

if [ "${media}" = "bhyve" ]; then
cat > ${TMP_DIR}/etc/ttys <<EOF
console "/usr/libexec/getty std.9600"   vt100   on secure
EOF
fi

case "${media}" in
"iso")
    /usr/local/cbsd/release/mkisoimages.sh ${LABEL} ${dstdir}/${jname}-${ver}_${arch}.iso ${TMP_DIR}
    ;;
"memstick")
    makefs -B little -o label=${LABEL} ${dstdir}/${jname}-${ver}_${arch}.img ${TMP_DIR}

    [ $? -ne 0 ] && err 1 "makefs failed"

    unit=`mdconfig -a -t vnode -f ${dstdir}/${jname}-${ver}_${arch}.img`
    [ $? -ne 0 ] && err 1 "mdconfig failed"
    gpart create -s BSD ${unit}
    gpart bootcode -b ${TMP_DIR}/boot/boot ${unit}
    gpart add -t freebsd-ufs ${unit}
    mdconfig -d -u ${unit}
    ;;
"bhyve")
    makefs -o label="${LABEL}" ${IMGSIZE} ${dstdir}/${jname}-${ver}_${arch}.img ${TMP_DIR}
    ;;
esac

[ "${ver}" != "empty" ] && cbsd unmountfstab jroot=${path} fstab=${mount_fstab} > /dev/null 2>&1
unmountbase
