#!/bin/sh
#v9.2.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="ver arch maxjobs clean name stable basename"
MYDESC="Build kernel from sources"
ADDHELP="ver=9_1 for 9.1 ver=. for current.\n\
stable=1 for RELENG_X\n\
destdir= for alternative install path in root dir\n"

set -e

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
init $*

. ${buildconf}
. ${color}

[ -n "${clean}" ] || clean=0

if [ -z "${name}" ]; then
    export __MAKE_CONF=${etcdir}/make.conf
else
    export __MAKE_CONF=${etcdir}/make-$name.conf
fi

if [ -z "${basename}" ]; then
    export MAKEOBJDIRPREFIX=${srcdir}/obj_${arch}_${ver}
else
    export MAKEOBJDIRPREFIX=${srcdir}/obj_${basename}_${arch}_${ver}
fi

if [ -z "${basename}" ]; then
    export SRCCONF=${etcdir}/src.conf
else
    export SRCCONF=${etcdir}/src-${basename}.conf
fi

[ "${arch}" = "amd64" -o "${arch}" = "i386" ] || err 1 "${MAGENTA}Supported architecture only: ${GREEN}amd64 i386${NORMAL}"

NOCLEANUP=""
[ ${clean} -eq 1 ] || NOCLEANUP="-DNO_CLEAN"

if [ -z "${name}" ]; then
    LOCKFILE=${SRCBASE}.lock
else
    LOCKFILE=${SRCBASE}-${name}.lock
fi

[ -z "${name}" ] && name="GENERIC"

if [ -n "${destdir}" ]; then
    DST="${destdir}"
else
    if [ -z "${basename}" ]; then
	DST="${basejaildir}/kernel_${name}_${arch}_${ver}"
    else
	DST="${basejaildir}/kernel_${basename}_${name}_${arch}_${ver}"
    fi
fi

SRCDIR="${srcdir}/src_${ver}"

case "${arch}" in
"i386")
    export MACHINE="i386"
    export UNAME_p="i386"
    export UNAME_m="i386"
    export TARGET="i386"
    export TARGET_ARCH="i386"
    export MACHINE_ARCH="i386"
    export BUILD_ARCH="i386"
    ;;
"amd64")   
    export MACHINE="amd64"
    export UNAME_p="amd64"
    export UNAME_m="amd64"
    export TARGET="amd64"
    export TARGET_ARCH="amd64"
    export MACHINE_ARCH="amd64"
    export BUILD_ARCH="amd64"
    ;;
esac

[ ! -f "${etcdir}/kernel-${name}-${arch}-${ver}" ] && err 1 "${MAGENTA}No such config kernel-${name}-${arch}-${ver} in: ${GREEN}${etcdir}${MAGENTA}"
cp ${etcdir}/kernel-${name}-${arch}-${ver} ${SRCDIR}/src/sys/${arch}/conf/${name}.CBSD
makelock $LOCKFILE "rm -f ${SRCDIR}/src/sys/${arch}/conf/${name}.CBSD"
/usr/bin/make -C ${SRCDIR}/src installkernel TARGET=${arch} KERNCONF=${name}.CBSD DESTDIR=${DST} ${NOCLEANUP}
