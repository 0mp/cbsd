#!/bin/sh
# ver9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="ver"
MYDESC="CSUP from official cvsup server"

set -e

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
init $*

# By default ver=current version
[ -n "${ver}" ] || ver=`uname -r|cut -d "-" -f1 |tr "." "_"`

if [ ${ver} = "." ]; then
    TAG=.
else
    TAG=RELENG_${ver}
fi

DST="${srcdir}/src_${ver}"

LOCKFILE=${DST}.lock
makelock ${LOCKFILE} "rm -f ${tmpdir}/supfile_${ver}"

[ -d "${DST}" ] || /bin/mkdir -p ${DST}

cat > ${tmpdir}/supfile_${ver} << EOF
*default host=${csuphost}
*default base=${dbdir}
*default prefix=${srcdir}/src_${ver}
*default release=cvs tag=${TAG}
*default delete use-rel-suffix
*default compress
src-all
EOF

/usr/bin/csup -z ${tmpdir}/supfile_${ver}
[ -f "$DST/src/Makefile" ] || rm -rf "$DST"
