#!/bin/sh
#v9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG="old new"
MYOPTARG="fqdn ip"
MYDESC="Jail cloning"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${tools}
. ${inventory}
. ${jfs}
init $*

[ -f "${globalconf}" ] || err 1 "no such conf file";
. ${globalconf}

DST="${jaildatadir}/${new}-${jaildatapref}"
SRC="${jaildatadir}/${old}-${jaildatapref}"
JAILDIR="${jaildir}/${new}"
JAILFSTAB="${jailfstabdir}/${jailfstabpref}${new}"
JAILFSTABORIG="${jailfstabdir}/${jailfstabpref}${old}"
JAILRCCONF="${jailrcconfdir}/rc.conf_${new}"
JAILRCCONFORIG="${jailrcconfdir}/rc.conf_${old}"

[ -d "${SRC}" ] || err 1 "No jail data at ${SRC}"
[ ! -d "${DST}" ] || err 1 "${DST} jail already exist"

[ -d "${JAILDIR}" ] || mkdir -p ${JAILDIR}
[ -d "${jailfstab}"  ] || mkdir -p $jailfstabdir
[ -d "${jailrcconf}"  ] || mkdir -p $jailrcconfdir

printf "Cloning."
cp ${JAILRCCONFORIG} ${JAILRCCONF}
dot "cp"
cp ${JAILFSTABORIG} ${JAILFSTAB}
dot "cp"
/usr/bin/sed "s/\/${old}/\/${new}/g" ${JAILFSTABORIG} > ${JAILFSTAB}
dot "sed"
/usr/bin/sed "s/_${old}_/_${new}_/g" ${JAILRCCONFORIG} > ${JAILRCCONF}
dot "sed"
modconf ${JAILRCCONF} jname ${new}
dot "modconf"
modconf ${JAILRCCONF} jail_list ${new}
dot "modconf"
cbsd jset jname=${new} hostname="${fqdn}"
cbsd jset jname=${new} ip="${ip}"
dot "jset ip"
cbsd jset jname=${new} rootdir="${jaildir}/${new}"
dot "jset rootdir"
cbsd jset jname=${new} fstab="${jailfstabdir}/${jailfstabpref}${new}"
dot "jset fstab"
cbsd jset jname=${new} data="${jaildatadir}/${new}-${jaildatapref}"
dot "jset data"
cbsd jset jname=${new} rcconf="${jailrcconfdir}/rc.conf_${new}"
dot "jset rcconf"

jname=${new}
clonedata $SRC $DST rsync
dot "cp"
err 0 "ok"
