#!/usr/local/bin/cbsd
#v9.2.2
globalconf="${workdir}/cbsd.conf";
MYARG="jname"

[ -f ${globalconf} ] || err 1 "no such conf file";

. ${globalconf}
. ${subr}
. ${color}

[ ! -f ${sharedir}/jail-arg ] && err 1 "${GREEN}no jail-arg file${NORMAL}";
. ${sharedir}/jail-arg

MYOPTARG="$JARG"
MYDESC="Modify parameter for jail"
ADDHELP="mode=force for modification on the running jail\n"

. ${inventory}
. ${tools}
init $*

# here we get status from jstatus, not via jrcconf for non-overwriting params in args
jid=`cbsd jstatus jname=${jname}`
[ $? -eq 0 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

for n in $@; do

    argpart=${n%%=*}

    for i in ${JARG}; do
        if [ "${argpart}" = "${i}" -a "${argpart}" != "jname" ]; then
            ##### check for already running
            if [ ${jid} -ne 0  ]; then
                if [ "${argpart}" != "ip4_addr" ]; then
                    ${ECHO} "${argpart}: ${MAGENTA}on-the-fly currentlry unimplemented${NORMAL}"
                else
                    eval VAL=\$$i
                    cbsdsql local UPDATE jails SET ${i}=\"${VAL}\" WHERE jname=\"${jname}\"
                    ${ECHO} "${argpart}: ${MAGENTA}changed${NORMAL}"
                fi
            else
                eval VAL=\$$i
                cbsdsql local UPDATE jails SET ${i}=\"${VAL}\" WHERE jname=\"${jname}\"
                ${ECHO} "${argpart}: ${MAGENTA}changed${NORMAL}"
            fi
        fi
    done

done

# exit code 0 is nessesary for dot()
exit 0
