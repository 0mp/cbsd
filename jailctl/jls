#!/usr/local/bin/cbsd
# v9.2.2
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="quiet alljails shownode node"
MYDESC="List jail and status"
ADDHELP="alljails=1 - get jaillist from remote note\
shownode=1 - show node ip\n\
node= only for current node\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${strings}
init $*

conv_status()
{
    case "${status}" in
	0)
	    status="Off"
	    ;;
	1)
	    status="On"
	    ;;
	2)
	    status="Slave"
	    ;;
	*)
	    status="Unknown"
	    ;;
    esac
}


show_local()
{
    local _errcode

    if [ -z "${shownode}" ]; then
	cbsdsql local SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails ORDER BY jname | while read jname jid ip4_addr host_hostname path status; do
	    conv_status
            echo "$jname     $jid     $ip4_addr     $host_hostname     $path     $status"
        done
    else
        cbsdsql local SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails ORDER BY jname | while read jname jid ip4_addr host_hostname path status; do
	    conv_status
            echo "${nodename}    $jname    $jid    $ip4_addr    $host_hostname    $path     $status"
        done
    fi

# Unregister area
    [ ! -d "${jailrcconfdir}" ] && return 0
    status="Unregister"
    jid="0"

    for J in `/bin/ls ${jailrcconfdir}`; do
	jname=""
	. ${jailrcconfdir}/${J}
	[ -z "${jname}" ] && continue

	if [ -z "$quiet" ]; then
	    if [ -n "$shownode" ]; then
		echo "${nodename}    $jname    $jid    $ip4_addr    $host_hostname    $path     $status"
	    else
		echo "$jname     $jid     $ip4_addr     $host_hostname     $path     $status"
	    fi
	else
	    /bin/echo "$jname"
	fi
    done
}


show_remote()
{
if [ -z "${node}" ]; then
    node=`cbsd node mode=list`
fi

for _n in $node; do
    [ "${_n}" = "${nodename}" ] && continue
    [ ! -f "${dbdir}/${_n}.sqlite" ] && echo "Node ${_n} have no sqlite db on local host" && continue
    if [ -z "$shownode" ]; then
	cbsdsql ${_n} SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails | while read jname jid ip4_addr host_hostname path status; do
	    conv_status
	    echo "$jname     $jid     $ip4_addr     $host_hostname     $path     $status"
	done
    else
	cbsdsql ${_n} SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails | while read jname jid ip4_addr host_hostname path status; do
	    conv_status
	    echo "${_n}    $jname    $jid    $ip4_addr    $host_hostname    $path     $status"
	done
    fi
done
}


#### MAIN
[ -n "$quiet" ] || {
    if [ -n "$shownode" ]; then
        echo "NODEIP      JNAME        JID       IP      Hostname      Path      Status"
    else
        echo "JNAME      JID      IP      Hostname      Path       Status"
    fi
}

export sqldelimer=" "

if [ -n "$alljails" ]; then
	show_local
	show_remote
	return 0
fi


if [ -n "${node}" ]; then
	show_remote
else
	show_local
fi
