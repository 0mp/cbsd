#!/usr/local/bin/cbsd
#v10.0.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="alljails shownode node header"
MYDESC="List jail and status"
ADDHELP="alljails=1 - get jaillist from remote node\n\
shownode=1 - show node ip\n\
node= only for current node\n\
header=0 don't print header\n"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${strings}
init $*

JLS=""

conv_status()
{
    case "${status}" in
	0)
	    status="Off"
	    ;;
	1)
	    status="On"
	    ;;
	2)
	    status="Slave"
	    ;;
	*)
	    status="Unknown"
	    ;;
    esac
}


show_header()
{

    if [ ${header} -ne 0 ]; then
	if [ -n "$shownode" ]; then
	    echo "NODEIP    JNAME    JID    IP    HOSTNAME    PATH    STATUS"
	else
	    echo "JNAME    JID    IP    HOSTNAME    PATH    STATUS"
	fi
    fi
}


show_local()
{
    local _errcode

    show_header

	cbsdsql local SELECT jname FROM jails| while read jname; do
	    . ${jrcconf}
	    [ $? -ne 0 ] && continue
	    [ ${baserw} -eq 1 ] && path=${data}
	    conv_status
	    if [ -z "${shownode}" ]; then
		echo  "${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	    else
		echo "${nodename} ${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	    fi
        done

	# Unregister area
	[ ! -d "${jailrcconfdir}" ] && return 0
	ip4_addr="-"
	host_hostname="-"
	path="-"
	status="Unregister"
	jid="0"

	for J in `/bin/ls ${jailrcconfdir}`; do
	    jname=""
	    . ${jailrcconfdir}/${J}
	    [ -z "${jname}" ] && continue

	if [ -n "$shownode" ]; then
	    echo "${nodename} ${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	else
	    echo "${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	fi
	done
}


show_remote()
{

    show_header

    if [ -z "${node}" ]; then
	node=`cbsd node mode=list header=0 allinfo=0`
    fi

    for _n in $node; do
	[ "${_n}" = "${nodename}" ] && continue
	[ ! -f "${dbdir}/${_n}.sqlite" ] && echo "Node ${_n} have no sqlite db on local host" && continue
	if [ -z "$shownode" ]; then
	    cbsdsql ${_n} SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails | while read jname jid ip4_addr host_hostname path status; do
		conv_status
		echo "${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	    done
	else
	    cbsdsql ${_n} SELECT jname,jid,ip4_addr,host_hostname,path,status FROM jails | while read jname jid ip4_addr host_hostname path status; do
		conv_status
		echo "${_n} ${jname} ${jid} ${ip4_addr} ${host_hostname} ${path} ${status}"
	    done
	fi
    done
}

show_jails()
{

    if [ -n "${node}" ]; then
	show_remote
	exit
    fi

    if [ -n "${alljails}" ]; then
	show_local
	header=0
	show_remote
    else
	show_local
    fi

}



#### MAIN
[ -z "${header}" ] && header=1
sqldelimer=" "
show_jails|column -t
