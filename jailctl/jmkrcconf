#!/usr/local/bin/cbsd
#v10.0.4
CBSDMODULE="jail"
MYARG="jname"

. ${subr}
. ${color}

[ ! -f ${sharedir}/jail-arg ] && err 1 "${GREEN}no jail-arg file${NORMAL}";
. ${sharedir}/jail-arg

MYOPTARG="$JARG mode"
MYDESC="Create ascii rc.conf for jail"
ADDHELP="mode=force for modification on the running jail\n"

. ${inventory}
. ${tools}
. ${strings}
init $*

. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

cat <<EOF
# DO NOT EDIT THIS FILE. PLEASE USE INSTEAD:
# cbsd jconfig jname=${jname}
EOF

for i in ${JARG}; do
    VAL=$(cbsdsql local SELECT ${i} FROM jails WHERE jname=\"${jname}\")
    [ "${VAL}" = "(null)" -o -z "${VAL}" ] && VAL=""
    echo "${i}=\"${VAL}\";"
done


if [ "${emulator}" = "bhyve" ]; then
    . ${sharedir}/bhyve.conf
    for i in ${MYCOL}; do
	[ "${i}" = "jname" ] && continue
	VAL=$(cbsdsql local SELECT ${i} FROM bhyve WHERE jname=\"${jname}\")
	[ "${VAL}" = "(null)" -o -z "${VAL}" ] && VAL=""
	echo "${i}=\"${VAL}\";"
    done


    unset dsklist
    sqldelimer=" "

    for last_disk in $( seq 1 16 ); do
	unset dsk_controller${last_disk}
    done

    dsk_id=1

    cbsdsql local SELECT dsk_controller,dsk_path,dsk_slot,dsk_type FROM bhyvedsk WHERE jname=\"${jname}\" | while read dsk_controller dsk_path dsk_slot dsk_type; do
	echo "dsk_controller${dsk_id}=\"${dsk_controller}\";"
	echo "dsk_path${dsk_id}=\"${dsk_path}\";"
	echo "dsk_slot${dsk_id}=\"${dsk_slot}\";"
	echo "dsk_type${dsk_id}=\"${dsk_type}\";"
	dsk_id=$(( dsk_id + 1 ))
    done || err 1 "${MAGENTA}Error while create disk map${NORMAL}"
fi

#finally set jname
echo "jname=\"${jname}\""

# exit code 0 is nessesary for dot()
exit 0
