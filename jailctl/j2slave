#!/bin/sh
#v9.2.1
globalconf="${workdir}/cbsd.conf";
MYARG="node jname"
MYOPTARG=""
MYDESC="Transfer jail as slave jail to remote node"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${color}

init $*

[ -z "${node}" ] && err 1 "${MAGENTA}Give me node${NORMAL}"
[ -z "${jname}" ] && err 1 "${MAGENTA}Give me jname${NORMAL}"

NODECFG="${rsshdir}/${node}.node"
[ ! -f "${NODECFG}" ] && err 1 "${MAGENTA}No node config found: ${GREEN}${NODECFG}${NORMAL}"

. ${NODECFG}
[ ! -f "${SSHKEY}" ] && err 1 "${MAGENTA}No node key found: ${GREEN}${SSHKEY}${NORMAL}"

SSHOP="-oBatchMode=yes -oStrictHostKeyChecking=no -oConnectTimeout=5 -oPort=${PORT} -q -i ${SSHKEY} "

A=`cbsd jstatus ${jname}`

case $? in
    0)
	err 1 "${MAGENTA}No such jail here: ${GREEN}${jname}${NORMAL}"
	;;
    1)
	JAILDIR="${jaildatadir}/${jname}-${jaildatapref}"
	;;
    2)
	JAILDIR="${jaildatadir}/${jname}-${jaildatapref}.slave"
	;;
esac

[ ! -d "${JAILDIR}" ] && err 1 "${MAGENTA}No such jaildir${NORMAL}"

/usr/local/bin/rsync --port=1873 -avz --delete --recursive --partial --password-file=${etcdir}/${jname}.secrets ${JAILDIR}/ rsync://${jname}@${IP}/${jname}/ > $DEBLOG 2>&1

dot "rsync"

exit 0
