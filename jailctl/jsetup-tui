#!/bin/sh
#v9.2.2
globalconf="${workdir}/cbsd.conf";

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${settingstui}
. ${color}
. ${dialog}
. ${strings}

MYARG="jname"
MYOPTARG="${JARG} outfile"

[ ! -f "${sharedir}/jail-arg" ] && err 1 "No such jail-arg skel"
. ${sharedir}/jail-arg
MYOPTARG="${JARG}"
MYDESC="Ncurses based setup for jail-arg"

init $*

commit()
{
    for i in ${JARG}; do
	eval VAL=\$$i
	[ -n "${VAL}" -a "${i}" != "jname" ] && cbsd jset mode=quiet jname=${jname} $i=\"${VAL}\"
    done
    exit
}

mainmenu()
{
    COUNT=

    for i in ${JARG}; do
	eval VAL=\$$i
	if [ -n "${VAL}" -a "${i}" != "jname" ]; then
		eval ${i}=`cbsd jget mode=quiet jname=${jname} ${VAL}`
		COUNT=$((COUNT + 1))
	fi
    done

    COUNT=$((COUNT+3))

    while [ 1 ]; do
	MENU_OPTIONS=
	for i in ${JARG}; do
	    eval VAL=\$$i
	    if [ -n "${VAL}" -a "${i}" != "jname" ]; then
	    MENU_OPTIONS="${MENU_OPTIONS} $i ${VAL}"
	    fi
	done

	$DIALOG --clear --title "Setup for ${jname}" --menu "\nselect action for ${jname}:" -1 70 ${COUNT} \
	    ${MENU_OPTIONS} \
	    "COMMIT" "Save changes and quit" \
	    "EXIT" "EXIT!" 2> ${TMPFILE}
	retval=$?

	choice=`cat ${TMPFILE}`
	rm -f ${TMPFILE}
	case $retval in
	    0)
		[ $choice = "jname" ] && get_jname
		[ $choice = "fqdn" ] && get_jail_fqdn
		[ $choice = "ip4_addr" ] && get_jail_ips
		[ $choice = "ver" ] && get_jail_base
		[ $choice = "baserw" ] && get_jail_baserw
		[ $choice = "mount_src" ] && get_jail_mount_src
		[ $choice = "mount_ports" ] && get_jail_mount_ports
		[ $choice = "astart" ] && get_jail_astart
		[ $choice = "interface" ] && get_jail_oninterface
		[ $choice = "vnet" ] && get_jail_vnet
		[ $choice = "applytpl" ] && get_jail_applytpl
		[ $choice = "floatresolv" ] && get_jail_floatresolv
		[ $choice = "arch" ] && get_jail_arch
		[ $choice = "COMMIT" ] && commit
		[ $choice = "EXIT" ] && exit
	    ;;
	    *)
		exit
	    ;;
	esac
    done
}

### MAIN
msg_ok="Ok"
msg_cancel="Cancel"

. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

A=`cbsd jstatus jname=${jname}`

[ "${A}" != "0" ] && err 1 "${MAGENTA}Modification of active jail on-the-fly currenlty not implemented. Please stop them first${NORMAL}"

mainmenu
