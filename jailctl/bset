#!/usr/local/bin/cbsd
#v11.0.5
MYARG="jname"
CBSDMODULE="bhyve"

. ${subr}

. ${sharedir}/bhyve.conf

#concat for bhyve arg
JARG="${MYCOL} vm_ram vm_cpus vm_hostbridge astart interface vm_boot vm_iso_path vm_efi vm_console vm_vnc_port protected hidden \
bhyve_generate_acpi bhyve_wire_memory bhyve_rts_keeps_utc bhyve_force_msi_irq bhyve_x2apic_mode bhyve_mptable_gen bhyve_ignore_msr_acc \
cd_vnc_wait bhyve_vnc_resolution bhyve_vnc_tcp_bind"

MYOPTARG="$JARG"
MYDESC="Modify parameter for jail"
ADDHELP="mode=force for modification on the running jail\n"

. ${tools}
. ${strings}
init $*

update_jails()
{
	eval VAL=\$$i

	case "${i}" in
		vm_ram)
			if is_number ${VAL}; then
				if conv2bytes ${VAL}; then
					VAL="${convval}"
				fi
			fi
		;;
	esac

	cbsdsql local UPDATE bhyve SET ${i}=\"${VAL}\" WHERE jname=\"${jname}\"
	${ECHO} "${argpart}: ${MAGENTA}changed${NORMAL}"

}

# here we get status from jstatus, not via jrcconf for non-overwriting params in args
jid=$( jstatus jname=${jname} )
[ $? -eq 0 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

for n in $@; do
	argpart=${n%%=*}

	for i in ${JARG}; do
		if [ "${argpart}" = "${i}" -a "${argpart}" != "jname" ]; then
			update_jails
		fi
	done
done

# exit code 0 is nessesary for dot()
exit 0
