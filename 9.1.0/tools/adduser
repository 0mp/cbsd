#!/bin/sh
#v9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG="jname login pw"
MYOPTARG="fullname group uid secgroup shell pw"
MYDESC="Add user to jail"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
init $*

check_jaildir()
{
if [ -f ${data}/etc/master.passwd -a -f ${data}/etc/passwd -a -f ${data}/etc/group ]; then
    return 0
else
    return 1
fi
}

JAILRCCONF="${jailrcconfdir}/rc.conf_${jname}"

[ -f ${JAILRCCONF} ] || err 1 "no conf rc.conf file for jail"
. ${JAILRCCONF}

eval data=\"\$data\"
eval base=\"\$base\"

ADDON=""

check_jaildir
if [ $? -eq 1 ]; then
    echo "bad data dir"
    return 1
    exit
fi

[ -n "$uid" ] && ADDON="${ADDON} -u ${uid}"
[ -n "$fullname" ] && ADDON="${ADDON} -c ${fullname}"
[ -n "$group" ] && ADDON="${ADDON} -g ${group}"
[ -n "$secgroup" ] && ADDON="${ADDON} -G ${secgroup}"
if [ -n "$shell" ]; then
 ADDON="${ADDON} -s ${shell}"
else
    ADDON="${ADDON} -s /bin/csh"
fi

/usr/sbin/pw useradd ${login} -V ${data}/etc ${ADDON}
echo "${pw}" |pw -V ${data}/etc mod user ${login} -h 0 -
mkdir ${data}/usr/home/${login}
