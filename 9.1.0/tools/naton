#!/bin/sh
#v9.0.0
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG=""
MYDESC="Enable NAT service for RFC1918 Networks"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
init $*

case "${nat_enable}" in
"ipnat")
    [ -f "${etcdir}/ipnat.rules" ] || err 1 "No ipnat.rules. run cbsd natcfg first"
    kldstat -q -m pf
    [ $? -eq 0 ] || kldload pf
    kldstat -q -m ipl
    [ $? -eq 0 ] || kldload ipl
    kldstat -q -m ipfilter
    [ $? -eq 0 ] || kldload ipfilter
    ipnat -CF -f ${etcdir}/ipnat.rules
;;
"ipfw")
    [ -f "${etcdir}/ipfw.rules" ] || err 1 "No ipfw.rules. run cbsd natcfg first"
    kldstat -q -m libalias
    [ $? -eq 1 ] || kldload libalias
    kldstat -q -m ipfw_nat
    [ $? -eq 1 ] || kldload ipfw_nat
    service ipnat onestop
    /sbin/ipfw delete 10
    sh ${etcdir}/ipfw.rules
;;
esac
